<!DOCTYPE html>
<html>
<head>
	<title>Crossover Automated Test Creator</title>

	<!-- Stylesheets -->
	<link rel="stylesheet" href="../../css/photon.min.css">
	<link rel="stylesheet" href="../../css/number-circle.css">

	<!-- Javascript -->
	<!-- Insert this line above script imports  -->
	<script>if (typeof module === 'object') {
		window.module = module;
		module = undefined;
	}</script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
<body>
<div class="window">

	<!-- .toolbar-header sits at the top of your app -->
	<!--<header class="toolbar toolbar-header">-->
	<!--&lt;!&ndash;<h1 class="title">Crossover Automated Test Creator</h1>&ndash;&gt;-->
	<!--<div class="toolbar-actions">-->
	<!--&lt;!&ndash;<input class="form-control" type="text" placeholder="Enter URL">&ndash;&gt;-->
	<!--<div class="btn-group">-->
	<!--<button class="btn btn-default">-->
	<!--<span class="icon icon-plus"></span>-->
	<!--</button>-->
	<!--<button class="btn btn-default">-->
	<!--<span class="icon icon-floppy"></span>-->
	<!--</button>-->
	<!--</div>-->
	<!--</div>-->
	<!--</header>-->

	<!-- Your app's content goes inside .window-content -->
	<div class="window-content">
		<div class="pane-group">
			<!--<div class="pane pane-sm sidebar">-->
			<!--<nav class="nav-group">-->
			<!--<h5 class="nav-group-title">-->
			<!--<div class="pull-right">-->
			<!--<button class="btn btn-default">-->
			<!--<span class="icon icon-plus"></span>-->
			<!--</button>-->
			<!--</div>-->
			<!--Tests-->
			<!--</h5>-->
			<!--<span class="nav-group-item">-->
			<!--<span class="icon icon-home"></span>-->
			<!--google-hello-word-->
			<!--</span>-->
			<!--</nav>-->
			<!--</div>-->
			<div class="pane pane-sm">
				<ul class="list-group" id="lst-steps">
					<li class="list-group-header">
						<div class="pull-right">
							<button id="btn-save" class="btn btn-default">
								<span class="icon icon-floppy"></span>
							</button>
						</div>
						<h5 class="nav-group-title">Steps</h5>
					</li>
				</ul>
			</div>
			<div class="pane">
				<webview id="webview" preload="./preload.js" src="http://www.google.com"
						 style="position:absolute;width:100%;height:100%;"></webview>
			</div>
		</div>
	</div>
</div>
<script>

	const webView = document.getElementById("webview");

	// target=_blank support for webviews in electron
	webView.addEventListener('new-window', options => {
		// Open blank targets in current window
		webView.src = options.url;
	});

	// Process the data from the webview
	webView.addEventListener('ipc-message', function (event) {
		console.log({
			channel: event.channel,
			args: event.args
		});

		openForm('new-step', event.args[0]);
	});

	function openForm(form, args) {
		const window = require('electron').remote.require('electron-window');

		const win = window.createWindow({
			width: 800,
			height: 600
		});

		win.showUrl(__dirname + `/../${form}/index.html`, args);
		return win;
	}

	const steps = [];

	function evaluateJS(js) {
		alert('JS:' + js);
		webView.executeJavaScript(js);
	}

	function runStep(num) {
		const step = steps[num - 1];

		alert('RUN_STEP:' + JSON.stringify(step));

		switch (step.action.toLowerCase()) {
			case 'inspect':
				evaluateJS(`alert(JSON.stringify($("${step.selector}")))`);
				break;
			case 'load url':
				const url = step.selector;
				webView.loadURL(url);
				break;
			case 'enter text':
				evaluateJS(`$("${step.selector}").val("${step.text}")`);
				break;
			case 'click':
//				evaluateJS(`$("${step.selector}")`);
				evaluateJS(`$("${step.selector}")[0].click()`);
//				evaluateJS(`document.getElementById("${step.selector}").click()`);
				break;
			case 'focus':
				evaluateJS(`$("${step.selector}").focus()`);
				break;
			case 'submit':
				evaluateJS(`$("${step.selector}").submit()`);
				break;
			default:
				alert('ACTION_NOT_SUPPORTED:' + step.action);
				break;
		}
	}

	function appendStep(step) {

		const action = step.action;
		const selector = step.selector;
		const text = step.text;

		const list = document.getElementById("lst-steps");
		const num = steps.length + 1;

		$(list).append(`<li class="list-group-item" id="step-${num}">
					<div class="numberCircle2 pull-left">${num}</div>
					<div class="pull-right">
						<button class="btn btn-default" onclick="runStep(${num})"><span class="icon icon-play"></span></button>
					</div>
					<div class="media-body">
					<strong>${action}</strong>
					<p style="font-style: italic">${selector}</p>

			</div>
			</li>`);

		steps.push(step);
	}

	const {ipcRenderer} = require('electron');
	ipcRenderer.on('append-step', (event, step) => {
		appendStep(step);
	});

	// ** Execute a step
	ipcRenderer.on('run-step', (event, step) => {
		alert('RUN_STEP:', step);
	});

	const btnSave = document.getElementById("btn-save");
	btnSave.addEventListener('click', () => {


//			appendStep({
//				action: 'click',
//				selector: '#lst'
//			})
	});
</script>
</body>
</html>
